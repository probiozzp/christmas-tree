<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D æ‰‹åŠ¿æ§åˆ¶ç²’å­åœ£è¯æ ‘</title>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; background:#05080f; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; }
    #ui{
      position:fixed; left:12px; top:12px; z-index:10;
      color:#fff; background:rgba(0,0,0,.25);
      padding:10px 12px; border-radius:12px; backdrop-filter: blur(6px);
      font-size:14px; line-height:1.35; max-width:520px;
      user-select:none;
    }
    #ui code{ opacity:.9; }
    #startBtn{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
      color:#fff; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-size:13px;
    }
    #startBtn:hover{ background:rgba(255,255,255,.12); }
    #startBtn:disabled{ opacity:.55; cursor:not-allowed; }
    #status{ margin-top:8px; font-size:12px; opacity:.85; white-space:pre-line; }

    #hint{
      position:fixed; left:12px; bottom:12px; z-index:10;
      color:rgba(255,255,255,.86); background:rgba(0,0,0,.25);
      padding:10px 12px; border-radius:12px; backdrop-filter: blur(6px);
      font-size:12px; line-height:1.4; max-width:520px; white-space:pre-line;
    }
    #err{
      position:fixed; right:12px; top:12px; z-index:20;
      display:none; max-width:560px; white-space:pre-wrap;
      color:#ffd7d7; background:rgba(80,0,0,.45);
      padding:10px 12px; border-radius:12px; font-size:12px;
    }
  </style>
</head>
<body>

<div id="ui">
  ğŸ„ 3D æ‰‹åŠ¿æ§åˆ¶ç²’å­åœ£è¯æ ‘ï¼ˆGitHub Pagesï¼‰
  <div style="margin-top:6px;opacity:.85">
    å›¾ç‰‡æ¥è‡ªä»“åº“ <code>assets/</code> æ–‡ä»¶å¤¹ï¼ˆè‡ªåŠ¨è¯»å–å…¨éƒ¨å›¾ç‰‡ï¼Œåç»­å¢åŠ æ— éœ€æ”¹ä»£ç ï¼‰
  </div>
  <button id="startBtn">â–¶ å¼€å§‹ä½“éªŒï¼ˆå¼€å¯æ‘„åƒå¤´ï¼‰</button>
  <div id="status">çŠ¶æ€ï¼šæœªå¯åŠ¨ï¼ˆä½ å¯ä»¥å…ˆçœ‹åˆ°ç²’å­æ ‘åŠ¨ç”»ï¼‰</div>
</div>

<div id="hint">
âœ… æ“ä½œæç¤ºï¼ˆç‚¹å‡»å¼€å§‹ä½“éªŒå¹¶å…è®¸æ‘„åƒå¤´åï¼‰
ğŸ‘‰ æ‰‹å·¦å³ç§»åŠ¨ï¼šæ—‹è½¬åœºæ™¯
âœ‹ å¼ å¼€æ‰‹æŒï¼šç²’å­æ•£å¼€æˆæ˜Ÿäº‘
âœŠ æ¡æ‹³ï¼šç²’å­é‡æ–°èšåˆæˆåœ£è¯æ ‘
ğŸ¤ æ‹‡æŒ‡+é£ŸæŒ‡æåˆï¼šæ”¾å¤§ã€Œå½“å‰æŒ‡å‘çš„ã€ç…§ç‰‡
ğŸ¤ æŒç»­æåˆ 300msï¼šè¿›å…¥è¯¦æƒ…æ¨¡å¼ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
æ— æ‰‹/æ¾å¼€ï¼šè‡ªåŠ¨å›é»˜è®¤
</div>

<div id="err"></div>
<video id="video" style="display:none" playsinline></video>

<!-- å…³é”®ï¼šMediaPipe ç”¨æ™®é€š script å¼•å…¥ï¼ˆä¸è¦ ESM importï¼‰ -->
<script src="https://unpkg.com/@mediapipe/hands/hands.js"></script>
<script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
/* ======================================================
 *  å·¥å…·ï¼šçŠ¶æ€/é”™è¯¯æ˜¾ç¤º
 * ====================================================== */
const statusBox = document.getElementById("status");
const errBox = document.getElementById("err");
function setStatus(s){ statusBox.textContent = "çŠ¶æ€ï¼š" + s; }
function showError(s){ errBox.style.display="block"; errBox.textContent = s; }

window.addEventListener("error", (e) => {
  showError("âŒ è¿è¡ŒæŠ¥é”™ï¼š\n" + (e?.message || e));
});
window.addEventListener("unhandledrejection", (e) => {
  showError("âŒ Promise æŠ¥é”™ï¼š\n" + (e?.reason?.message || e?.reason || e));
});

/* ======================================================
 *  å‚æ•°
 * ====================================================== */
const PARAMS = {
  TREE_HEIGHT: 6,
  TREE_RADIUS: 3,
  PARTICLE_COUNT: 4500,

  PINCH_MIN: 0.02,
  PINCH_MAX: 0.12,
  DETAIL_HOLD_MS: 300,

  NO_HAND_TIMEOUT_MS: 1200,
  DEFAULT_ROTATE_SPEED: 0.002,

  // æ‰‹åŠ¿é˜ˆå€¼ï¼ˆå¯è°ƒï¼‰
  OPEN_THRESHOLD: 0.55,
  FIST_THRESHOLD: 0.38,
};

/* ======================================================
 *  Three.js åœºæ™¯åˆå§‹åŒ–ï¼ˆä¸ä¾èµ–æ‘„åƒå¤´ï¼Œå…ˆä¿è¯èƒ½çœ‹åˆ°æ ‘ï¼‰
 * ====================================================== */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x05080f, 8, 22);

const camera3d = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
camera3d.position.set(0, 3, 10);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio || 1);
renderer.setClearColor(0x05080f, 1);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.22));

/* ======================================================
 *  ç²’å­æ ‘ï¼šæ ‘å½¢ <-> æ˜Ÿäº‘ æ··åˆ
 * ====================================================== */
const positions = new Float32Array(PARAMS.PARTICLE_COUNT*3);
const basePositions = new Float32Array(PARAMS.PARTICLE_COUNT*3);
const cloudPositions = new Float32Array(PARAMS.PARTICLE_COUNT*3);

for(let i=0;i<PARAMS.PARTICLE_COUNT;i++){
  // æ ‘é”¥ä½“
  const y = Math.random()*PARAMS.TREE_HEIGHT;
  const r = (1 - y/PARAMS.TREE_HEIGHT) * PARAMS.TREE_RADIUS;
  const a = Math.random()*Math.PI*2;
  const x = Math.cos(a)*r;
  const z = Math.sin(a)*r;
  positions.set([x,y,z], i*3);
  basePositions.set([x,y,z], i*3);

  // æ˜Ÿäº‘
  const t = Math.random()*Math.PI*2;
  const u = Math.random()*2 - 1;
  const rr = 4 + Math.random()*4;
  const cx = rr*Math.sqrt(1-u*u)*Math.cos(t);
  const cy = 2 + rr*u*0.35;
  const cz = rr*Math.sqrt(1-u*u)*Math.sin(t);
  cloudPositions.set([cx,cy,cz], i*3);
}

const geom = new THREE.BufferGeometry();
geom.setAttribute("position", new THREE.BufferAttribute(positions, 3));

const colors = new Float32Array(PARAMS.PARTICLE_COUNT*3);
const cGreen = new THREE.Color("#2cff9a");
const cGold  = new THREE.Color("#ffd27d");
const cWhite = new THREE.Color("#ffffff");
for(let i=0;i<PARAMS.PARTICLE_COUNT;i++){
  const r = Math.random();
  const c = r<0.55 ? cGreen : (r<0.85 ? cGold : cWhite);
  colors.set([c.r,c.g,c.b], i*3);
}
geom.setAttribute("color", new THREE.BufferAttribute(colors, 3));

const ptsMat = new THREE.PointsMaterial({
  size: 0.06,
  transparent: true,
  opacity: 0.9,
  depthWrite: false,
  blending: THREE.AdditiveBlending,
  vertexColors: true
});

const treePoints = new THREE.Points(geom, ptsMat);
scene.add(treePoints);

const star = new THREE.Mesh(
  new THREE.SphereGeometry(0.26, 18, 18),
  new THREE.MeshBasicMaterial({ color: 0xffffcc })
);
star.position.set(0, PARAMS.TREE_HEIGHT+0.3, 0);
scene.add(star);

/* ======================================================
 *  ç…§ç‰‡ï¼ˆä» assets/ è‡ªåŠ¨è¯»å–å…¨éƒ¨å›¾ç‰‡ï¼‰
 * ====================================================== */
const photoGroup = new THREE.Group();
scene.add(photoGroup);
const photoMeshes = [];

function placePhoto(mesh){
  const y = Math.random()*PARAMS.TREE_HEIGHT*0.85 + 0.5;
  const r = (1 - y/PARAMS.TREE_HEIGHT)*PARAMS.TREE_RADIUS + 0.6;
  const a = Math.random()*Math.PI*2;
  mesh.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
  mesh.lookAt(0, y, 0);
}

function addPhotoByUrl(url){
  const loader = new THREE.TextureLoader();
  loader.load(url, (tex)=>{
    tex.colorSpace = THREE.SRGBColorSpace;

    const geo = new THREE.PlaneGeometry(1,1);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent:true, opacity:1 });
    const mesh = new THREE.Mesh(geo, mat);

    placePhoto(mesh);
    photoGroup.add(mesh);
    photoMeshes.push(mesh);
  }, undefined, (err)=>{
    console.warn("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š", url, err);
  });
}

async function loadAssetsImagesAuto(){
  // è‡ªåŠ¨åˆ—ç›®å½•ï¼šGitHub API -> æ–‡ä»¶å -> ç”¨åŒåŸŸ ./assets/xxx åŠ è½½ï¼ˆé¿å…è·¨åŸŸçº¹ç†é—®é¢˜ï¼‰
  const owner = "probiozzp";
  const repo  = "christmas-tree";
  const path  = "assets";

  try{
    const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const res = await fetch(api, { cache: "no-store" });
    if(!res.ok){
      setStatus("å·²å¯åŠ¨ï¼ˆassets åˆ—è¡¨è¯»å–å¤±è´¥ï¼šè¯·ç¡®è®¤ assets/ å­˜åœ¨ä¸”æœ‰å›¾ç‰‡ï¼‰");
      return;
    }
    const items = await res.json();
    const exts = [".png",".jpg",".jpeg",".webp",".gif"];
    const files = items
      .filter(it => it.type==="file" && exts.some(ext => it.name.toLowerCase().endsWith(ext)))
      .map(it => it.name);

    if(files.length===0){
      setStatus("å·²å¯åŠ¨ï¼ˆassets/ é‡Œæ²¡æ‰¾åˆ°å›¾ç‰‡ï¼‰");
      return;
    }

    // å…³é”®ï¼šç”¨ç›¸å¯¹è·¯å¾„åŒåŸŸåŠ è½½ï¼ˆä½ ä»¥å assets å¢åŠ å›¾ç‰‡ï¼Œä¸ç”¨æ”¹ä»£ç ï¼‰
    files.forEach(name => addPhotoByUrl(`./assets/${encodeURIComponent(name)}`));

    setStatus(`æœªå¯åŠ¨æ‘„åƒå¤´ï¼ˆå·²å‘ç° assets å›¾ç‰‡ ${files.length} å¼ ï¼Œæ­£åœ¨åŠ è½½â€¦ï¼‰`);
  }catch(e){
    console.warn(e);
    setStatus("æœªå¯åŠ¨æ‘„åƒå¤´ï¼ˆassets åˆ—è¡¨è¯»å–å¤±è´¥ï¼‰");
  }
}
loadAssetsImagesAuto();

/* ======================================================
 *  Raycasterï¼ˆé£ŸæŒ‡ hoverï¼‰
 * ====================================================== */
const raycaster = new THREE.Raycaster();
let hoveredPhoto = null;

/* ======================================================
 *  æ‰‹åŠ¿çŠ¶æ€
 * ====================================================== */
let pinchStrength = 0;
let detailMode = false;
let lastPinchStart = 0;

let targetRotationY = 0;
let lastHandSeenAt = 0;

let mode = "TREE";     // TREE / CLOUD
let targetCloudMix = 0;
let cloudMix = 0;

// ä¿å­˜æœ€è¿‘ä¸€æ¬¡é£ŸæŒ‡ NDCï¼Œç”¨äº hover
let lastIndexNDC = null;

/* ======================================================
 *  MediaPipe Hands åˆå§‹åŒ–ï¼ˆç‚¹å‡»å¼€å§‹æŒ‰é’®åæ‰å¯åŠ¨æ‘„åƒå¤´ï¼‰
 * ====================================================== */
const video = document.getElementById("video");

const hands = new Hands({
  locateFile: (file) => `https://unpkg.com/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

hands.onResults((results)=>{
  const lm = results.multiHandLandmarks && results.multiHandLandmarks[0];
  if(!lm) return;

  lastHandSeenAt = performance.now();

  const indexTip = lm[8];
  const thumbTip = lm[4];

  // pinch å¼ºåº¦
  const d = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
  pinchStrength = THREE.MathUtils.clamp(
    (PARAMS.PINCH_MAX - d)/(PARAMS.PINCH_MAX - PARAMS.PINCH_MIN),
    0, 1
  );

  // æ—‹è½¬ï¼ˆç”¨é£ŸæŒ‡ xï¼‰
  const handX = indexTip.x - 0.5;
  targetRotationY = THREE.MathUtils.clamp(handX * 2.0, -1.2, 1.2);

  // ä¿å­˜ ndc
  lastIndexNDC = { x: indexTip.x*2 - 1, y: -(indexTip.y*2 - 1) };

  // å¼€æŒ/æ¡æ‹³å¯å‘å¼
  const palm = lm[0];
  const tips = [lm[8], lm[12], lm[16], lm[20]];
  const sumDist = tips.reduce((acc,p)=>acc + Math.hypot(p.x - palm.x, p.y - palm.y), 0);

  if(sumDist > PARAMS.OPEN_THRESHOLD) mode = "CLOUD";
  else if(sumDist < PARAMS.FIST_THRESHOLD) mode = "TREE";

  targetCloudMix = (mode==="CLOUD") ? 1 : 0;

  // è¯¦æƒ…æ¨¡å¼ï¼šå¼º pinch + hover ç›®æ ‡ï¼ŒæŒç»­ 300ms
  if(pinchStrength > 0.8 && hoveredPhoto){
    if(!lastPinchStart) lastPinchStart = performance.now();
    if(performance.now() - lastPinchStart > PARAMS.DETAIL_HOLD_MS) detailMode = true;
  }else{
    lastPinchStart = 0;
    detailMode = false;
  }
});

let cameraMP = null;
let started = false;

document.getElementById("startBtn").addEventListener("click", async ()=>{
  if(started) return;

  const btn = document.getElementById("startBtn");
  btn.disabled = true;
  setStatus("æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™â€¦ï¼ˆè¯·å…è®¸ï¼‰");

  try{
    cameraMP = new Camera(video, {
      onFrame: async () => {
        await hands.send({ image: video });
      },
      width: 640,
      height: 480
    });

    await cameraMP.start();
    started = true;
    setStatus("æ‘„åƒå¤´å·²å¼€å¯ âœ…ï¼ˆå¼€å§‹æ‰‹åŠ¿äº¤äº’ï¼‰");
  }catch(e){
    btn.disabled = false;
    started = false;
    setStatus("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ âŒ");

    const msg = e?.name ? `${e.name}: ${e.message}` : String(e);
    showError(
      "âŒ æ‘„åƒå¤´æ— æ³•å¯åŠ¨ã€‚\n\n" +
      "å¸¸è§åŸå› ï¼š\n" +
      "1) ä½ æ›¾ç»å¯¹è¯¥ç«™ç‚¹ç‚¹è¿‡â€œé˜»æ­¢æ‘„åƒå¤´â€ï¼ˆChrome ä»¥åä¸ä¼šå¼¹çª—ï¼‰\n" +
      "2) ç³»ç»Ÿè®¾ç½®é‡Œæœªå…è®¸ Chrome ä½¿ç”¨æ‘„åƒå¤´\n" +
      "3) æ‘„åƒå¤´è¢«å…¶ä»–ç¨‹åºå ç”¨\n\n" +
      "é”™è¯¯ä¿¡æ¯ï¼š\n" + msg + "\n\n" +
      "è§£å†³ï¼šç‚¹åœ°å€æ å·¦ä¾§å°é” â†’ ç½‘ç«™è®¾ç½® â†’ æ‘„åƒå¤´ â†’ å…è®¸ï¼Œç„¶ååˆ·æ–°å†ç‚¹å¼€å§‹ä½“éªŒã€‚"
    );
  }
});

/* ======================================================
 *  åŠ¨ç”»å¾ªç¯
 * ====================================================== */
const tmpV3 = new THREE.Vector3();
function animate(){
  requestAnimationFrame(animate);

  const now = performance.now();

  // æ— æ‰‹å›é€€
  if(now - lastHandSeenAt > PARAMS.NO_HAND_TIMEOUT_MS){
    pinchStrength = 0;
    detailMode = false;
    hoveredPhoto = null;
    mode = "TREE";
    targetCloudMix = 0;
    targetRotationY = 0;
    lastIndexNDC = null;
  }

  // hoverï¼šåªæœ‰å½“æœ‰ lastIndexNDC æ‰åš raycast
  if(lastIndexNDC && photoMeshes.length){
    raycaster.setFromCamera(lastIndexNDC, camera3d);
    const hits = raycaster.intersectObjects(photoMeshes);
    hoveredPhoto = hits[0]?.object || null;
  }else{
    hoveredPhoto = null;
  }

  // ç²’å­æ··åˆï¼ˆæ ‘å½¢<->æ˜Ÿäº‘ï¼‰
  cloudMix = THREE.MathUtils.lerp(cloudMix, targetCloudMix, 0.04);
  const pos = geom.attributes.position.array;

  for(let i=0;i<PARAMS.PARTICLE_COUNT;i++){
    const bi = i*3;
    const bx = basePositions[bi],     by = basePositions[bi+1], bz = basePositions[bi+2];
    const cx = cloudPositions[bi],    cy = cloudPositions[bi+1], cz = cloudPositions[bi+2];

    const floatY = Math.sin((Date.now()*0.001) + i) * 0.02;

    pos[bi]   = THREE.MathUtils.lerp(bx, cx, cloudMix);
    pos[bi+1] = THREE.MathUtils.lerp(by + floatY, cy, cloudMix);
    pos[bi+2] = THREE.MathUtils.lerp(bz, cz, cloudMix);
  }
  geom.attributes.position.needsUpdate = true;

  // åœºæ™¯æ—‹è½¬
  treePoints.rotation.y = THREE.MathUtils.lerp(treePoints.rotation.y, targetRotationY, 0.08);
  photoGroup.rotation.y = treePoints.rotation.y;

  // æ˜Ÿæ˜Ÿå‘¼å¸
  star.scale.setScalar(1 + Math.sin(Date.now()*0.002)*0.05);

  // ç…§ç‰‡ï¼šhover + pinch ç¼©æ”¾ + è¯¦æƒ…æ¨¡å¼æ·¡å‡º
  for(const m of photoMeshes){
    const isHover = (hoveredPhoto === m);
    const targetScale = isHover ? (1 + pinchStrength*1.6) : 1;
    m.scale.lerp(tmpV3.set(targetScale, targetScale, 1), 0.15);

    const baseOpacity = (detailMode && !isHover) ? 0.18 : 1;
    m.material.opacity = THREE.MathUtils.lerp(m.material.opacity, baseOpacity, 0.12);
  }

  // è¯¦æƒ…æ¨¡å¼ï¼šå±…ä¸­æ˜¾ç¤ºé€‰ä¸­ç…§ç‰‡
  if(detailMode && hoveredPhoto){
    hoveredPhoto.position.lerp(new THREE.Vector3(0, PARAMS.TREE_HEIGHT*0.55, 2.2), 0.08);
  }

  // æœªå¯åŠ¨æˆ–æ— æ‰‹ï¼šè½»å¾®è‡ªè½¬ï¼Œä¿è¯ä¸é»‘å±
  if(!started || (now - lastHandSeenAt > PARAMS.NO_HAND_TIMEOUT_MS)){
    treePoints.rotation.y += PARAMS.DEFAULT_ROTATE_SPEED;
    photoGroup.rotation.y = treePoints.rotation.y;
  }

  renderer.render(scene, camera3d);
}
animate();

window.addEventListener("resize", ()=>{
  camera3d.aspect = window.innerWidth/window.innerHeight;
  camera3d.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
